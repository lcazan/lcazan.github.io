<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover, interactive-widget=resizes-content">
    <title>Snoozing Builder | v4.3.92</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --admin-bg: #1e1e1e; --panel-bg: #2d2d2d; --brand-pink: #ebd5c9; }
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; position: fixed; top: 0; left: 0; background: #111; touch-action: none; }
        body { display: flex; font-family: 'Source Sans Pro', sans-serif; }
        
        #sidebar { width: 4.6875rem; height: 100%; background: var(--panel-bg); display: flex; flex-direction: column; align-items: center; padding: 0.9375rem 0; border-right: 0.125rem solid #000; flex-shrink: 0; z-index: 1000; }
        .export-wrap { margin-top: auto; margin-bottom: 60px; }
        .export-btn { width: 3.75rem; height: 3.75rem; background: var(--brand-pink); border: none; color: #000; border-radius: 50%; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 1.5rem; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.3)); }

        #preview-container { flex-grow: 1; display: flex; flex-direction: column; background: #333; height: 100%; overflow: hidden; position: relative; }
        #header-area { background: #222; border-bottom: 0.0625rem solid #000; height: 3.125rem; display: flex; align-items: center; justify-content: center; z-index: 1001; }
        
        #sticky-toolbar { height: 3rem; background: #1a1a1a; display: flex; align-items: center; justify-content: center; border-bottom: 0.0625rem solid #000; z-index: 1001; position: relative; }
        
        #input-pill {
            position: absolute; 
            top: calc(3rem + 1px); 
            left: 50%; transform: translateX(-50%);
            width: 85%; max-width: 550px; 
            background: #222;
            border: 1px solid #444; border-radius: 4px; 
            display: none; align-items: center; justify-content: center; 
            padding: 0 15px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            z-index: 1002;
        }
        #pill-editable { 
            color: white; width: 100%; font-size: 0.85rem; outline: none; 
            text-align: center; font-family: 'Courier New', monospace;
            line-height: 1.2;
            padding: 4px 0;
        }

        #frame-wrapper { flex-grow: 1; position: relative; background: #333; overflow: hidden; }
        #preview-frame { border: none; background: white; transform-origin: top left; position: absolute; top: 0; left: 0; }
        
        .insert-btn { width: 3.75rem; height: 2rem; background: #444; border: 0.0625rem solid #666; color: #fff; margin-bottom: 0.625rem; border-radius: 0.25rem; cursor: pointer; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; font-weight: bold; }
        .tool-btn { background: #444; border: 0.0625rem solid #666; color: white; min-width: 2.2rem; height: 2.2rem; display: flex; align-items: center; justify-content: center; border-radius: 0.25rem; cursor: pointer; font-size: 1.1rem; }
        
        .btn-teal { background: #008080 !important; border: none; font-size: 0.7rem; font-weight: 800; padding: 0 10px; }
        .btn-blue { background: #0056b3 !important; border: none; font-size: 0.7rem; font-weight: 800; padding: 0 10px; }

        .color-swatch { width: 1.5rem; height: 1.5rem; border: 1px solid #666; cursor: pointer; border-radius: 2px; }
        #toolbar-content { display: flex; gap: 0.5rem; visibility: hidden; align-items: center; height: 100%; }
        .device-btn { background: transparent; border: none; color: #fff; cursor: pointer; font-size: 1.5rem; margin: 0 0.6rem; }
        .device-btn.active { color: var(--brand-pink); }
        .version-status { position: absolute; right: 1.5625rem; top: 0.75rem; color: #fff; font-size: 1rem; font-weight: 800; }

        /* Toolbar Toggle Switch */
        .switch-container { display: flex; align-items: center; gap: 8px; color: white; font-size: 11px; font-weight: bold; }
        .switch { position: relative; display: inline-block; width: 34px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #555; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #3498db; }
        input:checked + .slider:before { transform: translateX(14px); }
    </style>
</head>
<body>

<div id="sidebar">
    <button class="insert-btn" onclick="insertElement('block_container')"><i class="fa-solid fa-square"></i></button>
    <button class="insert-btn" onclick="triggerImageUpload()"><i class="fa-solid fa-image"></i></button>
    <button class="insert-btn" onclick="insertElement('photo_gallery')"><i class="fa-solid fa-images"></i></button>
    <button class="insert-btn" onclick="insertElement('section_heading')">T<sub>1</sub></button>
    <button class="insert-btn" onclick="insertElement('block_heading')">T<sub>2</sub></button>
    <button class="insert-btn" onclick="insertElement('block_text')">T<sub>3</sub></button>
    <button class="insert-btn" onclick="insertElement('block_button')"><span>Btn</span></button>
    <button class="insert-btn" onclick="insertElement('block_spacer')"><i class="fa-solid fa-arrows-up-down"></i></button>
    <div class="export-wrap"><button class="export-btn" onclick="exportHTML()"><i class="fa-solid fa-download"></i></button></div>
</div>

<div id="preview-container">
    <div id="header-area">
        <div id="device-bar">
            <button class="device-btn" id="btn-desktop" onclick="setDevice('desktop')"><i class="fa-solid fa-desktop"></i></button>
            <button class="device-btn" id="btn-android" onclick="setDevice('android')"><i class="fa-solid fa-mobile-screen-button"></i></button>
            <button class="device-btn" id="btn-iphone" onclick="setDevice('iphone')"><i class="fa-solid fa-mobile"></i></button>
        </div>
        <div class="version-status">v4.3.92</div>
    </div>
    <div id="sticky-toolbar">
        <div id="toolbar-content"></div>
        <div id="input-pill">
            <span id="pill-editable" contenteditable="true" spellcheck="false" oninput="syncRealTime()"></span>
        </div>
    </div>
    <div id="frame-wrapper"><iframe id="preview-frame" scrolling="yes"></iframe></div>
</div>

<input type="file" id="image-upload" style="display:none" accept="image/*" onchange="handleImageUpload(this)">
<input type="file" id="input-camera" style="display:none" capture="environment" accept="image/*" multiple onchange="handleGalleryFiles(this.files)">
<input type="file" id="input-gallery" style="display:none" accept="image/*" multiple onchange="handleGalleryFiles(this.files)">
<input type="file" id="input-files" style="display:none" accept="image/*" multiple onchange="handleGalleryFiles(this.files)">

</body>
</html>
<script>
    const frame = document.getElementById('preview-frame');
    const toolbarContent = document.getElementById('toolbar-content');
    const wrapper = document.getElementById('frame-wrapper');
    let selectedEl = null; let currentMode = 'iphone'; let isResizing = false;
    let activePillMode = null;
    let currentTargetSlot = null;

    async function init() {
        const resp = await fetch('template.html');
        let html = await resp.text();
        html = html.replace('</head>', `
            <style>
                html, body { height: auto; min-height: 100%; margin: 0; padding: 0; overflow-x: hidden; }
                #editor-root { width: 100%; display: flex; flex-direction: column; padding-bottom: 250px; }
                .editable { position: relative; min-height: 1.2em; cursor: pointer; outline: none; box-sizing: border-box; }
                .selected-item { outline: 0.1875rem solid #ebd5c9 !important; }
                h2, h3, p { display: block !important; margin: 0 0 0.9375rem 0; padding-bottom: 0.625rem; color: inherit; font-family: inherit; }
                .editable:empty::before { content: attr(data-placeholder); color: #888; opacity: 0.6; pointer-events: none; }
                
                /* Gallery Grid Styles */
                .photo_gallery { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; width: 100%; margin: 20px 0; }
                @media (max-width: 768px) { .photo_gallery { grid-template-columns: repeat(2, 1fr); } }

                .photo_gallery.masonry-mode { display: block; column-count: 3; column-gap: 15px; }
                @media (max-width: 768px) { .photo_gallery.masonry-mode { column-count: 2; } }

                .gallery-item { position: relative; background: #fff; border-radius: 6px; overflow: hidden; aspect-ratio: 1/1; border: 1px solid #ddd; width: 100%; margin-bottom: 0; }
                .masonry-mode .gallery-item { display: inline-block; width: 100%; aspect-ratio: auto; margin-bottom: 15px; }
                
                .gallery-item img { width: 100%; height: 100%; object-fit: cover; display: block; pointer-events: none; }
                .masonry-mode .gallery-item img { height: auto; object-fit: contain; }

                .sentry-layer { position: absolute; inset: 0; z-index: 20; background: transparent; }
                .gallery-item.active .sentry-layer { z-index: -1; }
                
                .pan-overlay { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.25); color: white; font-size: 30px; opacity: 0; transition: 0.2s; cursor: ns-resize; z-index: 5; }
                .gallery-item.active .pan-overlay { opacity: 1; }
                .masonry-mode .pan-overlay { display: none !important; }

                .item-actions { position: absolute; top: 5px; right: 5px; display: flex; gap: 4px; opacity: 0; z-index: 10; transition: 0.2s; }
                .gallery-item.active .item-actions { opacity: 1; }
                .action-btn { width: 30px; height: 30px; background: rgba(0,0,0,0.8); color: white; border: none; border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
                
                .choice-menu { position: absolute; inset: 0; background: rgba(255,255,255,0.98); display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 8px; z-index: 100; opacity: 0; pointer-events: none; }
                .gallery-item.menu-open .choice-menu { opacity: 1; pointer-events: auto; }
                .choice-btn { width: 85%; padding: 8px; border: none; background: #3498db; color: white; border-radius: 4px; font-weight: 600; cursor: pointer; font-size: 10px; }

                .gallery-empty-slot { border: 2px dashed #bbb; cursor: pointer; display: flex; align-items: center; justify-content: center; background: #eee; min-height: 100px; }
                .gallery-empty-slot::before { content: '+'; font-size: 40px; color: #aaa; }

                .block_container { display: flex; flex-wrap: wrap; align-items: center; width: 100%; min-height: 2rem; box-sizing: border-box; }
                .block_image { position: relative; display: inline-block; flex-shrink: 0; }
                .block_image img { width: 100%; display: block; pointer-events: none; }
                .div-other-wrapper { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 1.2em; }
                .block_spacer { height: 1.5rem !important; width: 100%; border-bottom: none; }
                .resize-handle { width: 44px; height: 44px; position: absolute; right: -2px; bottom: -2px; cursor: nwse-resize; z-index: 9999; display: flex; align-items: center; justify-content: center; color: #ebd5c9; }
                .resize-handle::before { content: "\\f337"; font-family: "Font Awesome 6 Free"; font-weight: 900; font-size: 28px; }
            </style>
            <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"><\/script>
            <script>
                let isPanning = false, startY, startPos, activeImg;
                
                const observer = new ResizeObserver(entries => {
                    for (let entry of entries) {
                        const div = entry.target;
                        const width = entry.contentRect.width;
                        const img = div.querySelector('.block_image');
                        const other = div.querySelector('.div-other-wrapper');
                        if (!img) continue;
                        const factor = parseFloat(img.getAttribute('data-scale-factor') || '1.0');
                        if (width <= 744) {
                            div.style.flexDirection = 'column'; div.style.justifyContent = 'center';
                            img.style.width = (width * factor) + 'px'; img.style.margin = '0 auto';
                            if(other) other.style.width = '100%';
                        } else {
                            div.style.flexDirection = 'row'; div.style.justifyContent = 'flex-start';
                            const baseW = width * 0.618;
                            img.style.width = (baseW * factor) + 'px'; img.style.margin = '0';
                            if(other) other.style.width = 'auto';
                        }
                    }
                });

                window.initDivLogic = () => { document.querySelectorAll('.block_container').forEach(d => observer.observe(d)); };
                window.initSortable = (el) => { Sortable.create(el, { animation: 150, handle: '.drag-handle', filter: '.gallery-empty-slot' }); };

                window.beginPan = (e) => {
                    if (document.querySelector('.photo_gallery').classList.contains('masonry-mode')) return;
                    e.preventDefault(); e.stopPropagation();
                    isPanning = true;
                    activeImg = e.target.closest('.gallery-item').querySelector('img');
                    startY = e.touches ? e.touches[0].clientY : e.clientY;
                    const currentPos = activeImg.style.objectPosition.split(' ')[1];
                    startPos = parseFloat(currentPos) || 50;
                };

                const onMove = (e) => {
                    if (!isPanning || !activeImg) return;
                    const y = e.touches ? e.touches[0].clientY : e.clientY;
                    let delta = (startY - y) * 0.4;
                    let newPos = Math.max(0, Math.min(100, startPos + delta));
                    activeImg.style.objectPosition = "center " + newPos + "%";
                };
                const onEnd = () => { isPanning = false; activeImg = null; };
                window.addEventListener('mousemove', onMove);
                window.addEventListener('mouseup', onEnd);
                window.addEventListener('touchmove', onMove, {passive:false});
                window.addEventListener('touchend', onEnd);
            <\/script>
            <link rel="stylesheet" href="styles.css"></head>`);
        
        frame.srcdoc = html.replace(/<div class=\"content-container\">([\s\S]*?)<\/div>/, '<div class=\"content-container\" id=\"editor-root\">$1</div>');
        frame.onload = () => {
            frame.contentWindow.initDivLogic();
            frame.contentDocument.addEventListener('mousedown', (e) => { 
                if (isResizing) return;
                const el = e.target.closest('.editable') || e.target.closest('.div-other-wrapper > *') || e.target.closest('.block_spacer') || e.target.closest('.photo_gallery'); 
                if (el && el === selectedEl && (el.contentEditable === "true")) return;
                if (el) selectElement(el); else { deselectAll(); closeAllGalleryUI(); }
            });
            setDevice('iphone');
        };
    }

    // --- Core Builder Functions (Restored Baseline) ---
    function selectElement(el) {
        const doc = frame.contentDocument; doc.querySelectorAll('.resize-handle').forEach(h => h.remove());
        if(selectedEl && selectedEl !== el) selectedEl.classList.remove('selected-item');
        selectedEl = el; selectedEl.classList.add('selected-item');
        if (el.classList.contains('block_image')) addResizeHandle(el);
        renderToolbar(); 
        if(el.contentEditable === "true") el.focus();
    }

    function renderToolbar() {
        if (!selectedEl) return;
        toolbarContent.style.visibility = 'visible';
        const isBtn = selectedEl.classList.contains('block_button_container');
        const isImg = selectedEl.classList.contains('block_image');
        const isSpacer = selectedEl.classList.contains('block_spacer');
        const isDiv = selectedEl.classList.contains('block_container');
        const isGallery = selectedEl.classList.contains('photo_gallery');
        
        let html = '';
        if (isGallery) {
            const isMasonry = selectedEl.classList.contains('masonry-mode');
            html += `<div class="switch-container"><span>SQR</span><label class="switch"><input type="checkbox" ${isMasonry ? 'checked' : ''} onchange="parent.toggleMasonry()"><span class="slider"></span></label><span>MSN</span></div>`;
        } else if (isDiv) {
            html += `<div class="color-swatch" style="background:#FAF6F3" onclick="updateColor('#FAF6F3')"></div><input type="color" oninput="updateColor(this.value)">`;
        } else if (isBtn) {
            html += `<button class="tool-btn btn-teal" onclick="openPill('text')">TEXT</button><button class="tool-btn btn-blue" onclick="openPill('link')">LINK</button>`;
        } else if (isImg) {
            html += `<button class="tool-btn" onclick="triggerImageUpload()"><i class="fa-solid fa-sync"></i></button><button class="tool-btn" onclick="fitToWidth()"><i class="fa-solid fa-arrows-left-right"></i></button>`;
        } else if (isSpacer) {
            html += `<button class="tool-btn" onclick="toggleSpacerLine()"><i class="fa-solid fa-underline"></i></button>`;
        } else if (selectedEl.contentEditable === "true") {
            html += `<button class="tool-btn" onmousedown="event.preventDefault(); execCmd('bold')"><i class="fa-solid fa-bold"></i></button>`;
        }
        html += `<button class="tool-btn" style="color:#ff6b6b" onclick="deleteElement()"><i class="fa-solid fa-trash"></i></button>`;
        toolbarContent.innerHTML = html;
    }

    function addResizeHandle(el) {
        const handle = frame.contentDocument.createElement('div');
        handle.className = 'resize-handle';
        const startResize = (e) => {
            e.preventDefault(); e.stopPropagation();
            isResizing = true;
            const startX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const startW = el.offsetWidth;
            const widths = { 'desktop': 1200, 'android': 448, 'iphone': 393 };
            const scale = wrapper.offsetWidth / widths[currentMode];
            const onMove = (mE) => {
                const curX = mE.type.includes('touch') ? mE.touches[0].clientX : mE.clientX;
                let newW = startW + (curX - startX) / scale;
                el.style.width = Math.max(40, newW) + 'px';
            };
            const onUp = () => {
                isResizing = false;
                frame.contentDocument.removeEventListener('mousemove', onMove);
                frame.contentDocument.removeEventListener('mouseup', onUp);
            };
            frame.contentDocument.addEventListener('mousemove', onMove);
            frame.contentDocument.addEventListener('mouseup', onUp);
        };
        handle.addEventListener('mousedown', startResize);
        el.appendChild(handle);
    }

    // --- Gallery Logic ---
    function toggleMasonry() { if(selectedEl) { selectedEl.classList.toggle('masonry-mode'); renderToolbar(); } }

    function createNewSlot() {
        const doc = frame.contentDocument;
        const slot = doc.createElement('div');
        slot.className = 'gallery-item gallery-empty-slot';
        slot.onclick = (e) => { e.stopPropagation(); closeAllGalleryUI(); slot.classList.add('menu-open'); };
        addGalleryMenu(slot);
        return slot;
    }

    function addGalleryMenu(slot) {
        slot.innerHTML += `<div class="choice-menu">
            <button class="choice-btn" onclick="parent.triggerGalleryPick('input-camera', event)">CAMERA</button>
            <button class="choice-btn" onclick="parent.triggerGalleryPick('input-gallery', event)">PHOTOS</button>
            <button class="choice-btn" onclick="parent.triggerGalleryPick('input-files', event)">FILES</button>
        </div>`;
    }

    function triggerGalleryPick(id, e) {
        e.stopPropagation();
        currentTargetSlot = frame.contentDocument.querySelector('.menu-open');
        document.getElementById(id).click();
        closeAllGalleryUI();
    }

    async function handleGalleryFiles(files) {
        if (!files.length || !currentTargetSlot) return;
        const gallery = currentTargetSlot.parentElement;
        for (let i = 0; i < files.length; i++) {
            const reader = new FileReader();
            const promise = new Promise(res => {
                reader.onload = (e) => {
                    const slot = (i === 0) ? currentTargetSlot : frame.contentDocument.createElement('div');
                    if (i > 0) slot.className = 'gallery-item';
                    fillGallerySlot(slot, e.target.result);
                    if (i > 0) gallery.insertBefore(slot, gallery.lastElementChild);
                    res();
                };
            });
            reader.readAsDataURL(files[i]);
            await promise;
        }
        if (!gallery.lastElementChild.classList.contains('gallery-empty-slot')) gallery.appendChild(createNewSlot());
    }

    function fillGallerySlot(slot, src) {
        slot.classList.remove('gallery-empty-slot', 'menu-open');
        slot.innerHTML = `
            <div class="sentry-layer" onclick="event.stopPropagation(); parent.closeAllGalleryUI(); this.closest('.gallery-item').classList.add('active')"></div>
            <img src="${src}" style="object-position: center 50%;">
            <div class="pan-overlay" onmousedown="frame.contentWindow.beginPan(event)">
                <i class="fa-solid fa-arrows-up-down"></i>
            </div>
            <div class="item-actions">
                <button class="action-btn drag-handle"><i class="fa-solid fa-arrows-up-down-left-right"></i></button>
                <button class="action-btn" onclick="event.stopPropagation(); parent.closeAllGalleryUI(); this.closest('.gallery-item').classList.add('menu-open')"><i class="fa-solid fa-sync"></i></button>
                <button class="action-btn" onclick="event.stopPropagation(); this.closest('.gallery-item').remove()"><i class="fa-solid fa-trash"></i></button>
            </div>`;
        addGalleryMenu(slot);
    }

    function insertElement(type, data) {
        const doc = frame.contentDocument;
        const root = doc.getElementById('editor-root');
        if (type === 'photo_gallery') {
            const g = doc.createElement('div'); g.className = 'photo_gallery'; g.appendChild(createNewSlot());
            root.appendChild(g); frame.contentWindow.initSortable(g); return;
        }
        const tagMap = { 'section_heading': 'h2', 'block_heading': 'h3', 'block_text': 'p' };
        const el = doc.createElement(tagMap[type] || 'div');
        el.className = `editable ${type === 'block_button' ? 'block_button_container' : type}`;
        if(type === 'block_image') { el.innerHTML = `<img src="${data || 'https://via.placeholder.com/400x200'}">`; el.contentEditable = "false"; el.style.width = "200px"; }
        else if(type === 'block_button') { el.innerHTML = `<a href=\"#\" class=\"block_button\" onclick=\"return false;\">FIND OUT MORE</a>`; el.contentEditable = "false"; }
        else if(type === 'block_spacer' || type === 'block_container') { el.contentEditable = "false"; }
        else { el.innerText = ""; el.setAttribute('data-placeholder', 'Type here...'); el.contentEditable = "true"; }
        root.appendChild(el);
        if(type === 'block_container') frame.contentWindow.initDivLogic();
        setTimeout(() => selectElement(el), 150);
    }

    function closeAllGalleryUI() { frame.contentDocument.querySelectorAll('.gallery-item').forEach(i => i.classList.remove('menu-open', 'active')); }
    function fitToWidth() { if(selectedEl) selectedEl.style.width = '100%'; }
    function toggleSpacerLine() { if(selectedEl) selectedEl.style.borderBottom = selectedEl.style.borderBottom === 'none' ? '1px solid #eee' : 'none'; }
    function setDevice(type) {
        currentMode = type;
        const widths = { 'desktop': 1200, 'android': 448, 'iphone': 393 };
        const scale = Math.min(wrapper.offsetWidth / widths[type], 1);
        frame.style.width = widths[type] + 'px'; frame.style.transform = `scale(${scale})`;
    }
    function deleteElement() { if(selectedEl) { selectedEl.remove(); deselectAll(); } }
    function deselectAll() { if(selectedEl) selectedEl.classList.remove('selected-item'); selectedEl = null; toolbarContent.style.visibility = 'hidden'; }
    window.onload = init;
</script>
