<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>VFD Pro 3.1</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
        * { box-sizing: border-box; touch-action: manipulation; -webkit-user-select: none; user-select: none; }
        body, html { background-color: #050505; height: 100vh; width: 100vw; margin: 0; font-family: 'Share Tech Mono', monospace; overflow: hidden; position: fixed; }

        /* Display Layout */
        .display-area { background: #010808; position: absolute; top: 0; left: 0; width: 100%; height: 45vh; padding: 15px; display: flex; flex-direction: column; z-index: 10; }
        .history-viewport { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; }
        #history-container { margin-top: auto; display: flex; flex-direction: column; }
        .history-item { display: flex; flex-direction: column; padding: 5px 15px; font-size: 1.1rem; color: #26bf9e; border-bottom: 1px solid #0a2a24; }
        .history-item span:last-child { align-self: flex-end; color: #33ffcc; font-weight: bold; font-size: 1.4rem; }

        .divider { height: 3px; width: 100%; background: #33ffcc; box-shadow: 0 0 10px rgba(51, 255, 204, 0.5); margin: 8px 0; }
        .tag-container { display: flex; justify-content: space-between; padding: 0 15px; margin-bottom: 5px; }
        .version-tag { font-size: 0.7rem; color: #1a6354; }
        .status-tag { font-size: 0.7rem; color: #33ffcc; }

        .current-line { display: flex; align-items: center; justify-content: flex-end; color: #33ffcc; font-size: 3.2rem; font-weight: bold; text-shadow: 0 0 8px rgba(51, 255, 204, 0.5); min-height: 4rem; padding-right: 10px; }
        .cursor { display: inline-block; width: 15px; height: 2.8rem; background-color: #33ffcc; margin-left: 4px; animation: blink 0.6s step-end infinite; }
        @keyframes blink { from, to { opacity: 1; } 50% { opacity: 0; } }

        /* Flush-Bottom Grid */
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: 0.6fr repeat(8, 1fr); gap: 4px; background: #000; position: absolute; bottom: 0; width: 100%; height: 55vh; padding: 4px; padding-bottom: env(safe-area-inset-bottom); }
        button { height: 100%; font-size: 1.4rem; font-weight: bold; background: #1a1a1a; color: #eee; border: none; border-radius: 2px; font-family: 'Share Tech Mono', monospace; transition: filter 0.1s; }
        button:active { filter: brightness(1.5); }
        
        /* Specialized Colors */
        .util-btn { font-size: 0.85rem; background: #0d1d25; color: #7ab8d6; }
        .shift-btn { background: #f5a623; color: #000; }
        .shift-active { background: #f5a623 !important; box-shadow: 0 0 15px #f5a623; }
        .alpha-active { background: #26bf9e !important; box-shadow: 0 0 15px #26bf9e; color: #000; }
        .eq { background: #004d3d; color: #33ffcc; }
        .ac { background: #3d0000; color: #ff9999; }
    </style>
</head>
<body>

<div class="display-area">
    <div class="history-viewport" id="viewport"><div id="history-container"></div></div>
    <div class="divider"></div>
    <div class="tag-container">
        <div class="version-tag">VERSION 3.1</div>
        <div id="status-tag" class="status-tag">READY</div>
    </div>
    <div id="input-line" class="current-line"></div>
</div>

<div class="grid" id="keypad">
    <button class="util-btn" id="u1">RND</button>
    <button class="util-btn" id="u2">√</button>
    <button class="util-btn" id="u3">1/x</button>
    <button class="util-btn" id="u4">FRAC</button>

    <button id="shiftBtn" class="shift-btn">SHIFT</button>
    <button data-val="left">◀</button><button data-val="right">▶</button><button class="ac" data-val="ac">CLR</button>
    
    <button data-val="7">7</button><button data-val="8">8</button><button data-val="9">9</button><button data-val="/">÷</button>
    <button data-val="4">4</button><button data-val="5">5</button><button data-val="6">6</button><button data-val="*">×</button>
    <button data-val="1">1</button><button data-val="2">2</button><button data-val="3">3</button><button data-val="-">-</button>
    <button data-val="0">0</button><button data-val=".">.</button><button data-val="ans">ANS</button><button data-val="+" class="op">+</button>
    
    <button data-val="(">(</button><button data-val=")">)</button><button data-val="^">^</button><button class="eq" data-val="=">EXE</button>
</div>

<script>
    let entryArr = [], cursorIdx = 0, lastAnswer = 0, shiftState = 0; // 0: none, 1: Yellow, 2: Green
    let history = [];
    let shiftTimer;

    const uLabels = [
        ['RND', 'FIX', 'LOG'],
        ['√', 'AVG', 'CLIP'],
        ['1/x', 'MOD', 'TAX'],
        ['FRAC', 'SUM', 'HYP']
    ];

    function updateDisplay() {
        const uBtns = [document.getElementById('u1'), document.getElementById('u2'), document.getElementById('u3'), document.getElementById('u4')];
        uBtns.forEach((btn, i) => btn.innerText = uLabels[i][shiftState]);
        
        const sBtn = document.getElementById('shiftBtn');
        sBtn.className = 'shift-btn' + (shiftState === 1 ? ' shift-active' : (shiftState === 2 ? ' alpha-active' : ''));

        let left = entryArr.slice(0, cursorIdx).join('');
        let right = entryArr.slice(cursorIdx).join('');
        document.getElementById('input-line').innerHTML = left + '<span class="cursor"></span>' + right;
    }

    function gcd(a, b) { return b ? gcd(b, a % b) : a; }
    function to64th(val) {
        let dec = Math.abs(val % 1);
        let whole = Math.floor(Math.abs(val));
        let 64ths = Math.round(dec * 64);
        if (64ths === 0) return whole.toString();
        if (64ths === 64) return (whole + 1).toString();
        let common = gcd(64ths, 64);
        return `${whole > 0 ? whole + " " : ""}${64ths/common}/${64/common}`;
    }

    document.getElementById('shiftBtn').addEventListener('pointerdown', () => {
        shiftTimer = setTimeout(() => { shiftState = 2; updateDisplay(); }, 500);
    });

    document.getElementById('keypad').addEventListener('pointerup', (e) => {
        clearTimeout(shiftTimer);
        const btn = e.target.closest('button'); if (!btn) return;
        const val = btn.dataset.val;
        const id = btn.id;

        if (id === 'shiftBtn') { if(shiftState !== 2) shiftState = shiftState === 1 ? 0 : 1; updateDisplay(); return; }

        if (id.startsWith('u')) {
            const idx = parseInt(id[1]) - 1;
            executeUtility(idx, shiftState);
            shiftState = 0;
        } else if (val === '=') {
            solve();
        } else if (val === 'ac') {
            entryArr = []; cursorIdx = 0;
        } else if (val) {
            entryArr.splice(cursorIdx, 0, val);
            cursorIdx++;
        }
        updateDisplay();
    });

    function executeUtility(btnIdx, mode) {
        if (mode === 0) { // Primary
            const ops = ['RND(', '√(', '1/(', '']; 
            if (btnIdx === 3) { // FRAC primary
                let f = to64th(lastAnswer); entryArr = f.split(''); cursorIdx = entryArr.length;
            } else {
                entryArr.splice(cursorIdx, 0, ...ops[btnIdx].split('')); cursorIdx += ops[btnIdx].length;
            }
        } else if (mode === 1) { // Yellow
            const ops = ['FIX(', 'AVG(', 'MOD(', 'SUM('];
            entryArr.splice(cursorIdx, 0, ...ops[btnIdx].split('')); cursorIdx += ops[btnIdx].length;
        } else if (mode === 2) { // Green
            if (btnIdx === 0) { entryArr.splice(cursorIdx, 0, ...'LOG('.split('')); cursorIdx += 4; }
            if (btnIdx === 1) { navigator.clipboard.writeText(lastAnswer); }
            if (btnIdx === 2) { // TAX
                let sum = history.reduce((a, b) => a + Number(b.res), 0);
                lastAnswer = (sum * 0.06).toFixed(2);
                entryArr = lastAnswer.split(''); cursorIdx = entryArr.length;
            }
            if (btnIdx === 3) { entryArr.splice(cursorIdx, 0, ...'HYP('.split('')); cursorIdx += 4; }
        }
    }

    function solve() {
        try {
            let expr = entryArr.join('').replace(/×/g, '*').replace(/÷/g, '/');
            // Simplified eval for demonstration
            lastAnswer = eval(expr.replace(/ANS/g, lastAnswer));
            history.push({expr: entryArr.join(''), res: lastAnswer});
            renderHistory();
            entryArr = []; cursorIdx = 0;
        } catch(e) { entryArr = ['E','R','R']; cursorIdx = 3; }
    }

    function renderHistory() {
        const container = document.getElementById('history-container');
        container.innerHTML = history.map(h => `<div class="history-item"><span>${h.expr}</span><span>= ${h.res}</span></div>`).join('');
        document.getElementById('viewport').scrollTop = 99999;
    }

    updateDisplay();
</script>
</body>
</html>
