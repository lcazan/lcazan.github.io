<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>VFD Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#050505">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
        * { box-sizing: border-box; touch-action: manipulation; -webkit-user-select: none; user-select: none; -webkit-touch-callout: none; }
        body, html { background-color: #050505; height: 100vh; width: 100vw; margin: 0; font-family: 'Share Tech Mono', monospace; overflow: hidden; position: fixed; }
        .display-area { background: #010808; position: absolute; top: 0; left: 0; width: 100%; height: 45vh; padding: 15px; display: flex; flex-direction: column; z-index: 10; }
        .display-area::after { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: radial-gradient(circle, transparent 20%, rgba(0,0,0,0.7) 70%); background-size: 2px 2px; pointer-events: none; z-index: 20; }
        .history-viewport { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; scroll-behavior: smooth; }
        #history-container { margin-top: auto; display: flex; flex-direction: column; }
        
        .history-item { 
            display: flex; flex-direction: column; align-items: stretch; justify-content: center; 
            min-height: 55px; padding: 8px 15px; margin: 2px 0; font-size: 1.2rem; 
            color: #26bf9e; flex-shrink: 0; transition: background 0.2s ease; word-break: break-all; 
        }
        .history-item span:first-child { align-self: flex-start; text-align: left; line-height: 1.2; margin-bottom: 4px; }
        .history-item span:last-child { align-self: flex-end; text-align: right; font-weight: bold; color: #33ffcc; }
        .history-item.selected { color: #004d40 !important; background: #33ffcc; border-radius: 4px; box-shadow: 0 0 15px rgba(51, 255, 204, 0.6); }
        .history-item.selected span:last-child { color: #ffffff !important; text-shadow: 0 0 5px rgba(0,0,0,0.3); }
        
        .divider { height: 3px; width: 100%; background: #33ffcc; box-shadow: 0 0 10px rgba(51, 255, 204, 0.5); margin: 8px 0; flex-shrink: 0; z-index: 21; }
        .extra-line { position: absolute; top: 45vh; left: 0; width: 100%; height: 1px; background: #2a2a2a; z-index: 22; }
        
        .tag-container { display: flex; justify-content: space-between; align-items: center; padding: 0 15px; margin-top: 2px; z-index: 23; }
        .version-tag { font-size: 0.7rem; color: #1a6354; letter-spacing: 1px; }
        .status-group { display: flex; gap: 20px; }
        .status-tag { font-size: 0.7rem; color: #33ffcc; letter-spacing: 1px; min-width: 40px; text-align: right; }
        #mem-tag { color: #f5a623; display: none; }
        #mem-tag.active { display: block; }
        #notif-tag { color: #ffcc00; font-weight: bold; }

        .current-line { 
            display: block; text-align: right; color: #33ffcc; font-size: 3rem; font-weight: bold; 
            text-shadow: 0 0 8px rgba(51, 255, 204, 0.5); white-space: nowrap; min-height: 5.5rem; 
            flex-shrink: 0; z-index: 15; overflow-x: auto; overflow-y: hidden; padding-bottom: 5px;
        }
        .current-line::-webkit-scrollbar { display: none; }
        .cursor { display: inline-block; width: 18px; height: 2.6rem; background-color: #33ffcc; vertical-align: middle; margin-left: 2px; animation: blink 0.5s step-end infinite; }
        @keyframes blink { from, to { opacity: 1; } 50% { opacity: 0; } }
        
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: 0.5fr repeat(8, 1fr); gap: 6px; padding: 10px; background: #0a0a0a; position: absolute; bottom: 0; left: 0; width: 100%; height: 55vh; z-index: 5; padding-bottom: calc(10px + env(safe-area-inset-bottom)); }
        button { height: 100%; font-size: 1.8rem; font-weight: bold; background: linear-gradient(145deg, #222, #111); color: #fff; border: 1px solid #000; border-radius: 4px; box-shadow: 0 3px #000; font-family: 'Share Tech Mono', monospace; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: filter 0.05s ease, background 0.2s ease; outline: none; -webkit-tap-highlight-color: transparent; line-height: 1; }
        .sub-label { font-size: 0.7rem; letter-spacing: 1px; margin-top: 4px; opacity: 0.8; font-weight: normal; }
        
        .util-btn { font-size: 1rem; background: linear-gradient(145deg, #1a3a4a, #0d1d25); color: #7ab8d6; border-color: #244d61; }
        button:not(.shift-btn):active { filter: brightness(1.6); }
        .nav-btn { color: #33ffcc; background: #181818; }
        .eq { background: #003328; color: #33ffcc; border: 1px solid #1a8a7a; }
        .shift-btn { background: #f5a623 !important; color: #fff !important; font-size: 1.2rem; }
        .shift-active { background: #ff8c00 !important; box-shadow: 0 0 12px #ff8c00 !important; }
        .ac { background: #330000; color: #ff9999; }
        .ac-shift { background: #990000 !important; color: #fff !important; filter: brightness(1.4); }
        .sci-active { color: #ffcc00 !important; text-shadow: 0 0 12px #ff8c00, 0 0 20px rgba(255, 140, 0, 0.4); }
        sup { font-size: 0.8rem; line-height: 0; vertical-align: baseline; position: relative; top: -0.4em; }
    </style>
</head>
<body>
    <div class="display-area">
        <div class="history-viewport" id="viewport"><div id="history-container"></div></div>
        <div class="divider"></div>
        <div class="tag-container">
            <div class="version-tag">VERSION 3.2</div>
            <div class="status-group">
                <div id="notif-tag" class="status-tag"></div>
                <div id="mem-tag" class="status-tag">MEM</div>
                <div id="status-tag" class="status-tag">RND 9</div>
            </div>
        </div>
        <div id="input-line-container" class="current-line"></div>
    </div>
    <div class="extra-line"></div>
    <div class="grid" id="main-grid">
        <button id="rndBtn" class="util-btn" data-val="rnd_mode">RND</button>
        <button class="util-btn" data-val="n64">n/64</button>
        <button id="sqrtBtn" class="util-btn" data-val="root">√</button>
        <button class="util-btn" data-val="recip">1/x</button>
        <button id="shiftBtn" class="shift-btn" data-val="shift">SHIFT</button>
        <button class="nav-btn" data-val="left">◀</button>
        <button class="nav-btn" data-val="right">▶</button>
        <button id="acBtn" class="ac" data-val="ac"><span>CLR</span><span class="sub-label">Mem-</span></button>
        <button class="nav-btn" data-val="up">▲</button>
        <button id="expBtn" data-val="exp">e<sup>x</sup></button>
        <button data-val="π">π</button>
        <button data-val="del">⌫</button>
        <button class="nav-btn" data-val="down">▼</button>
        <button data-val="(">(</button>
        <button data-val=")">)</button>
        <button data-val="^">^</button>
        <button id="sinBtn" data-val="sin">SIN</button>
        <button id="cosBtn" data-val="cos">COS</button>
        <button id="tanBtn" data-val="tan">TAN</button>
        <button data-val="/">÷</button>
        <button data-val="7">7</button><button data-val="8">8</button><button data-val="9">9</button><button data-val="*">×</button>
        <button data-val="4">4</button><button data-val="5">5</button><button data-val="6">6</button><button data-val="-">-</button>
        <button data-val="1">1</button><button data-val="2">2</button><button data-val="3">3</button><button data-val="+">+</button>
        <button data-val="0">0</button><button data-val=".">.</button>
        <button id="ansBtn" data-val="ans"><span>ANS</span><span class="sub-label">Recall</span></button>
        <button class="eq" data-val="="><span>⏎</span><span class="sub-label">Mem+</span></button>
    </div>
<script>
    // [The logic remains identical to the previous fixed Version 3.2]
    // Including the scientific mode fix, n/64 fix, and navigation fix.
    
    let entryArr = [], cursorIdx = 0, lastAnswer = 0, shiftMode = false;
    let sciMode = localStorage.getItem('vfdSciMode') === 'true';
    let stickyMemory = localStorage.getItem('vfdStickyMemory') || "0";
    let historyIndex = -1, fullHistory = JSON.parse(localStorage.getItem('vfdHistory')) || [];
    let rndMode = false, currentRnd = parseInt(localStorage.getItem('vfdRnd')) || 9;
    let holdTimer, isHolding = false;

    const viewport = document.getElementById('viewport'), historyContainer = document.getElementById('history-container');
    const inputDisplay = document.getElementById('input-line-container'), statusTag = document.getElementById('status-tag');
    const memTag = document.getElementById('mem-tag'), notifTag = document.getElementById('notif-tag');

    function triggerHaptic(strong = false) { if (navigator.vibrate) navigator.vibrate(strong ? 15 : 1); }
    function updateStatus() { 
        statusTag.innerText = sciMode ? "SCI" : "RND " + currentRnd; 
        memTag.classList.toggle('active', stickyMemory !== "0");
    }
    function showNotif(text) { notifTag.innerText = text; setTimeout(() => { notifTag.innerText = ""; }, 1500); }

    function formatVal(val) {
        if (isNaN(val) && typeof val !== 'string') return val;
        if (typeof val === 'string' && val.includes('/')) return val;
        if (sciMode) return (Number(val) === 0) ? "0.0000e+0" : Number(val).toExponential(4);
        return Number(val).toFixed(currentRnd).replace(/\.?0+$/, "");
    }

    function getFractionMatrix(decimal) {
        let val = parseFloat(decimal);
        if (isNaN(val)) return { res: "0", ind: "" };
        let sign = val < 0 ? "-" : "";
        let absVal = Math.abs(val);
        let whole = Math.floor(absVal);
        let frac = absVal - whole;
        let rawNum = frac * 64, roundedNum = Math.round(rawNum);
        let indicator = (Math.abs(roundedNum - rawNum) > 0.0001) ? (roundedNum > rawNum ? "+" : "-") : "";
        let finalWhole = (roundedNum === 64) ? whole + 1 : whole;
        let finalNum = (roundedNum === 64 || roundedNum === 0) ? 0 : roundedNum;
        const gcd = (a, b) => b ? gcd(b, a % b) : a;
        let fractionStr = (finalNum === 0) ? sign + finalWhole.toString() : 
            sign + (finalWhole > 0 ? finalWhole + " " : "") + (finalNum/gcd(finalNum, 64)) + "/" + (64/gcd(finalNum, 64));
        return { res: fractionStr, ind: indicator, raw: val };
    }

    function initHistory() {
        historyContainer.innerHTML = '';
        fullHistory.forEach((item) => {
            const div = document.createElement('div');
            div.className = 'history-item';
            div.setAttribute('data-ans', item.rawRes !== undefined ? item.rawRes : item.res);
            let indicatorHtml = item.ind ? `<span style="margin-left:8px; font-size:0.8em; opacity:0.7;">${item.ind}</span>` : "";
            div.innerHTML = `<span>${item.expr}</span><span>= ${formatVal(item.res)}${indicatorHtml}</span>`;
            historyContainer.appendChild(div);
        });
        viewport.scrollTop = viewport.scrollHeight;
        updateStatus();
    }

    function evalSub(p) {
        let s = p.toString().replace(/ANS/gi, `(${lastAnswer})`).replace(/π/g, 'Math.PI').replace(/e\^/g, `(${Math.E})**`).replace(/×/g, '*').replace(/÷/g, '/').replace(/\^/g, '**').replace(/√\(/g, 'Math.sqrt(');
        const R2D = (180 / Math.PI), D2R = (Math.PI / 180);
        const invTrig = { 'ASIN': Math.asin, 'ACOS': Math.acos, 'ATAN': Math.atan };
        for (let [key, func] of Object.entries(invTrig)) {
            s = s.replace(new RegExp(key + "\\(([^\\(\\)]+)\\)", "gi"), (m, i) => `(${func(evalSub(i)) * R2D})`);
        }
        return eval(s.replace(/SIN\(/gi, `Math.sin(${D2R}*`).replace(/COS\(/gi, `Math.cos(${D2R}*`).replace(/TAN\(/gi, `Math.tan(${D2R}*`).replace(/LN\(/gi, 'Math.log('));
    }

    function renderEntry() {
        let left = entryArr.slice(0, cursorIdx).join(''), right = entryArr.slice(cursorIdx).join('');
        let cursorHtml = (historyIndex === -1) ? '<span id="active-cursor" class="cursor"></span>' : '';
        inputDisplay.innerHTML = left + cursorHtml + right;
        inputDisplay.style.opacity = (historyIndex !== -1) ? '0.4' : '1';
        setTimeout(() => { document.getElementById('active-cursor')?.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' }); }, 10);
        
        const btns = { ans: document.getElementById('ansBtn'), ac: document.getElementById('acBtn'), rnd: document.getElementById('rndBtn'), sqrt: document.getElementById('sqrtBtn') };
        btns.ans.querySelector('span:first-child').innerText = shiftMode ? 'SCI' : 'ANS';
        btns.ans.classList.toggle('sci-active', sciMode);
        btns.rnd.innerText = shiftMode ? 'AVG' : 'RND';
        btns.sqrt.innerText = shiftMode ? 'TAX' : '√';
        btns.ac.querySelector('span:first-child').innerText = shiftMode ? 'CLS' : 'CLR';
        btns.ac.classList.toggle('ac-shift', shiftMode);
        document.getElementById('expBtn').innerHTML = shiftMode ? 'LN' : 'e<sup>x</sup>';
        ['sin','cos','tan'].forEach(f => document.getElementById(f+'Btn').innerText = (shiftMode?'A':'')+f.toUpperCase());
        updateStatus();
    }

    function handleInput(val) {
        if (rndMode && !isNaN(val)) { currentRnd = parseInt(val); localStorage.setItem('vfdRnd', currentRnd); rndMode = false; initHistory(); return; }
        if (val === 'rnd_mode') { if (shiftMode) { let a = 'AVG('; entryArr.splice(cursorIdx, 0, ...a.split('')); cursorIdx += a.length; shiftMode = false; } else rndMode = true; renderEntry(); return; }
        const items = Array.from(document.querySelectorAll('.history-item')).reverse();
        if (val === 'shift') { shiftMode = !shiftMode; renderEntry(); return; }
        if (val === 'ans' && shiftMode) { sciMode = !sciMode; localStorage.setItem('vfdSciMode', sciMode); shiftMode = false; initHistory(); renderEntry(); return; }
        if (val === 'left') { cursorIdx = shiftMode ? 0 : Math.max(0, cursorIdx - 1); shiftMode = false; renderEntry(); return; }
        if (val === 'right') { cursorIdx = shiftMode ? entryArr.length : Math.min(entryArr.length, cursorIdx + 1); shiftMode = false; renderEntry(); return; }
        if (val === 'up') { if (historyIndex < items.length - 1) { historyIndex++; items[historyIndex].scrollIntoView({ behavior: 'smooth', block: 'center' }); } items.forEach((it, i) => it.classList.toggle('selected', i === historyIndex)); renderEntry(); return; }
        if (val === 'down') { if (historyIndex > -1) { historyIndex--; if (historyIndex === -1) viewport.scrollTop = viewport.scrollHeight; else items[historyIndex].scrollIntoView({ behavior: 'smooth', block: 'center' }); } items.forEach((it, i) => it.classList.toggle('selected', i === historyIndex)); renderEntry(); return; }
        if (val === '=') {
            if (historyIndex !== -1) {
                let v = shiftMode ? items[historyIndex].querySelector('span:first-child').innerText : items[historyIndex].getAttribute('data-ans');
                entryArr.splice(cursorIdx, 0, ...v.toString().split('')); cursorIdx += v.toString().length; historyIndex = -1;
            } else solve();
        } else if (val === 'ac') {
            if (shiftMode) { fullHistory = []; localStorage.removeItem('vfdHistory'); historyContainer.innerHTML = ''; lastAnswer = 0; }
            entryArr = []; cursorIdx = 0; historyIndex = -1; shiftMode = false;
        } else if (val === 'del') { if (cursorIdx > 0) { entryArr.splice(cursorIdx - 1, 1); cursorIdx--; } }
        else if (val === 'recip') instantRecip();
        else if (val === 'n64') instantN64();
        else {
            if (entryArr.length === 0 && ['+', '-', '*', '/', '^'].includes(val)) { entryArr = ['A','N','S']; cursorIdx = 3; }
            let t = val === 'ans' ? 'ANS' : val === 'root' ? (shiftMode?'TAX(':'√(') : ['sin','cos','tan'].includes(val) ? (shiftMode?'A':'')+val.toUpperCase()+'(' : val === 'exp' ? (shiftMode?'LN(':'e^') : val;
            entryArr.splice(cursorIdx, 0, ...t.split('')); cursorIdx += t.length; shiftMode = false;
        }
        renderEntry();
    }

    function solve() {
        try {
            let e = entryArr.join(''); if (!e) return;
            let o = (e.match(/\(/g)||[]).length, c = (e.match(/\)/g)||[]).length;
            while(o > c) { e += ')'; c++; }
            let p = e.replace(/AVG\(([^)]+)\)/g, (m, i) => `(${i.split('+').map(x=>evalSub(x)).reduce((a,b)=>a+b,0)/i.split('+').length})`)
                     .replace(/TAX\(([^)]+)\)/g, (m, i) => `(${i.split('+').map(x=>evalSub(x)).reduce((a,b)=>a+b,0)*0.06})`);
            lastAnswer = evalSub(p);
            fullHistory.push({expr: e, res: lastAnswer, ind: ""});
            localStorage.setItem('vfdHistory', JSON.stringify(fullHistory));
            initHistory(); entryArr = []; cursorIdx = 0;
        } catch (err) { entryArr = ['E','R','R','O','R']; cursorIdx = 5; }
        renderEntry();
    }

    function instantN64() {
        try {
            let e = entryArr.length > 0 ? entryArr.join('') : "ANS";
            let m = getFractionMatrix(evalSub(e)); lastAnswer = m.raw;
            fullHistory.push({ expr: `n/64(${e})`, res: m.res, ind: m.ind, rawRes: m.raw });
            localStorage.setItem('vfdHistory', JSON.stringify(fullHistory));
            initHistory(); entryArr = []; cursorIdx = 0;
        } catch(err) { entryArr = ['E','R','R','O','R']; cursorIdx = 5; }
        renderEntry();
    }

    function instantRecip() {
        try {
            let e = entryArr.length > 0 ? entryArr.join('') : "ANS";
            let v = evalSub(e); if (v === 0) throw "Div0";
            lastAnswer = 1/v;
            fullHistory.push({expr: `1/(${e})`, res: lastAnswer, ind: ""});
            localStorage.setItem('vfdHistory', JSON.stringify(fullHistory));
            initHistory(); entryArr = []; cursorIdx = 0;
        } catch(err) { entryArr = ['E','R','R','O','R']; cursorIdx = 5; }
        renderEntry();
    }

    document.getElementById('main-grid').addEventListener('pointerdown', (e) => {
        const btn = e.target.closest('button'); if (!btn) return;
        const val = btn.getAttribute('data-val');
        triggerHaptic(); isHolding = false;
        if (val === 'ans' || val === '=' || val === 'ac') {
            holdTimer = setTimeout(() => {
                isHolding = true;
                if (val === '=') {
                    const items = Array.from(document.querySelectorAll('.history-item')).reverse();
                    if (historyIndex !== -1) stickyMemory = items[historyIndex].getAttribute('data-ans');
                    else if (entryArr.length > 0) { solve(); stickyMemory = lastAnswer.toString(); }
                    localStorage.setItem('vfdStickyMemory', stickyMemory);
                    showNotif("SAVED"); triggerHaptic(true); updateStatus();
                } else if (val === 'ans') {
                    entryArr.splice(cursorIdx, 0, ...stickyMemory.split(''));
                    cursorIdx += stickyMemory.length; renderEntry(); triggerHaptic(true);
                } else if (val === 'ac') {
                    stickyMemory = "0"; localStorage.setItem('vfdStickyMemory', stickyMemory);
                    showNotif("MEM CLR"); triggerHaptic(true); updateStatus();
                }
            }, 500);
        }
    });

    document.getElementById('main-grid').addEventListener('pointerup', (e) => {
        clearTimeout(holdTimer);
        const btn = e.target.closest('button');
        if (btn && !isHolding) handleInput(btn.getAttribute('data-val'));
    });

    initHistory(); renderEntry();
</script>
</body>
</html>
